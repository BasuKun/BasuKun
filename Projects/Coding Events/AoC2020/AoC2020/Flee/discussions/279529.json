[
  {
    "Id": "698456",
    "ThreadId": "279529",
    "Html": "\r\n<p>There is a bug in the int64 specific method:</p>\r\n<p><strong>Protected Shared Sub EmitLoad(ByVal value As Int64, ByVal ilg As FleeILGenerator)</strong></p>\r\n<p><strong>Reproduction:</strong></p>\r\n<p>Try evaluating a datetime expression with the following expression: &gt;&nbsp;#11/14/2011# &#43; ##00:07:00#</p>\r\n<p><strong>Result:</strong></p>\r\n<p>The expression compilation fails with the following error:</p>\r\n<p>An error occurred with the following error message: &quot;System.OverflowException: Arithmetic operation resulted in an overflow.<br>\r\n<span style=\"white-space:pre\"></span>at Ciloci.Flee.LiteralElement.EmitLoad(Int64 value, FleeILGenerator ilg)<br>\r\n<span style=\"white-space:pre\"></span>at Ciloci.Flee.TimeSpanLiteralElement.Emit(FleeILGenerator ilg, IServiceProvider services)<br>\r\n<span style=\"white-space:pre\"></span>at Ciloci.Flee.BinaryExpressionElement.EmitOverloadedOperatorCall(MethodInfo method, FleeILGenerator ilg, IServiceProvider services)<br>\r\n<span style=\"white-space:pre\"></span>at Ciloci.Flee.ArithmeticElement.Emit(FleeILGenerator ilg, IServiceProvider services)<br>\r\n<span style=\"white-space:pre\"></span>at Ciloci.Flee.BinaryExpressionElement.EmitOverloadedOperatorCall(MethodInfo method, FleeILGenerator ilg, IServiceProvider services)<br>\r\n<span style=\"white-space:pre\"></span>at Ciloci.Flee.CompareElement.Emit(FleeILGenerator ilg, IServiceProvider services)<br>\r\n<span style=\"white-space:pre\"></span>at Ciloci.Flee.RootExpressionElement.Emit(FleeILGenerator ilg, IServiceProvider services)<br>\r\n<span style=\"white-space:pre\"></span>at Ciloci.Flee.Expression`1.Compile(String expression, ExpressionOptions options)<br>\r\n<span style=\"white-space:pre\"></span>at Ciloci.Flee.Expression`1..ctor(String expression, ExpressionContext context, Boolean isGeneric)<br>\r\n<span style=\"white-space:pre\"></span>at Ciloci.Flee.ExpressionContext.CompileGeneric[TResultType](String expression)</p>\r\n<p><strong>Expected Result:</strong></p>\r\n<p>The expression should evaluate properly.</p>\r\n<p><strong>Explanation:</strong></p>\r\n<p>The code tries to optimize the emitted instruction by detecting the value can fit in UInt32. However the method handling the optimized generation is the method for handling Int32. This can overflow and in fact it that what happens.</p>\r\n<p><strong>Resolution:</strong></p>\r\n<p>1. I modified the method as follows:</p>\r\n<p>Protected Shared Sub EmitLoad(ByVal value As Int64, ByVal ilg As FleeILGenerator)<br>\r\n<span style=\"white-space:pre\"></span>If value &gt;= Int32.MinValue And value &lt;= Int32.MaxValue Then<br>\r\n<span style=\"white-space:pre\"></span>EmitLoad(CInt(value), ilg)<br>\r\n<span style=\"white-space:pre\"></span>ilg.Emit(OpCodes.Conv_I8)<br>\r\n<span style=\"white-space:pre\"></span>ElseIf value &gt;= 0 And value &lt;= UInt32.MaxValue Then<br>\r\n<span style=\"white-space:pre\"></span>EmitLoad(CUInt(value), ilg)<br>\r\n<span style=\"white-space:pre\"></span>ilg.Emit(OpCodes.Conv_U8)<br>\r\n<span style=\"white-space:pre\"></span>Else<br>\r\n<span style=\"white-space:pre\"></span>ilg.Emit(OpCodes.Ldc_I8, value)<br>\r\n<span style=\"white-space:pre\"></span>End If<br>\r\nEnd Sub</p>\r\n<p>2. Included one additional method:</p>\r\n<p>Private Shared Sub EmitLoad(ByVal value As UInt32, ByVal ilg As FleeILGenerator)<br>\r\n<span style=\"white-space:pre\"></span>If value &gt;= 0 And value &lt;= 8 Then<br>\r\n<span style=\"white-space:pre\"></span>EmitSuperShort(value, ilg)<br>\r\n<span style=\"white-space:pre\"></span>ElseIf value &gt;= 0 And value &lt;= SByte.MaxValue Then<br>\r\n<span style=\"white-space:pre\"></span>ilg.Emit(OpCodes.Ldc_I4_S, CSByte(value))<br>\r\n<span style=\"white-space:pre\"></span>Else<br>\r\n<span style=\"white-space:pre\"></span>ilg.Emit(OpCodes.Ldc_I4, value)<br>\r\n<span style=\"white-space:pre\"></span>End If<br>\r\nEnd Sub</p>\r\n",
    "PostedDate": "2011-11-15T07:50:05.88-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]